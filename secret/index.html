<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secret Page</title>
    <style>
      :root{--bg:#f7f7f7;--card:#fff;--accent:#222;--muted:#666}
      body{font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg);margin:0;padding:2rem}
      .container{max-width:880px;margin:0 auto;background:var(--card);padding:1.5rem;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
      h1{margin:0 0 .25rem}
      p.lead{color:var(--muted)}
      label{display:block;margin-top:1rem}
      input{width:100%;padding:.6rem;font-size:1rem;margin-top:.5rem;border:1px solid #ddd;border-radius:6px}
      button{margin-top:.8rem;padding:.6rem 1rem;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer}
      .hidden{display:none}
      .secret-content{margin-top:1.25rem;text-align:center}
      .preview{display:block;max-width:680px;margin:0 auto;border-radius:8px;border:2px solid #eee;background:#fff}
      .note{margin-top:.75rem;color:var(--muted)}
      .back{display:inline-block;margin-top:1rem}
      .status{font-weight:600;margin-top:.5rem}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Secret — Next Page</h1>
      <p class="lead">This page loads the secret content reliably using JavaScript. Enter the 4-digit code or click the secret button on the home page.</p>

      <label for="code">Code</label>
      <input id="code" type="password" inputmode="numeric" maxlength="4" placeholder="Enter 4-digit code" autocomplete="off" />

      <button id="secretBtn" class="hidden" aria-expanded="false" aria-controls="secretArea">Reveal Secret</button>

      <div id="secretArea" class="secret-content hidden" aria-live="polite">
        <div id="previewWrap"></div>
        <p id="secretText" class="note">Enter the code to reveal the secret image.</p>
        <div id="status" class="status" aria-hidden="true"></div>
      </div>

      <a class="back" href="../">← Back to home</a>
    </div>

    <script>
    (function(){
      // Configuration
      const SECRET = '1234';
      const IMAGE_URL = 'https://ethan4291.github.io/thedailybarknews/static/funnydexter.jpeg';
      const MAX_RETRIES = 3;

      // UI refs
      const input = document.getElementById('code');
      const btn = document.getElementById('secretBtn');
      const area = document.getElementById('secretArea');
      const previewWrap = document.getElementById('previewWrap');
      const text = document.getElementById('secretText');
      const status = document.getElementById('status');

      // Helper: sleep
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      // Robust fetch-as-blob with retries and backoff
      async function fetchImageBlob(url, maxRetries=MAX_RETRIES) {
        let attempt = 0;
        let lastErr = null;
        while (attempt <= maxRetries) {
          try {
            const res = await fetch(url, {cache: 'no-store'});
            if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
            const contentType = res.headers.get('Content-Type') || '';
            if (!contentType.startsWith('image/')) throw new Error('Invalid content-type: ' + contentType);
            const blob = await res.blob();
            return blob;
          } catch (err) {
            lastErr = err;
            attempt++;
            if (attempt > maxRetries) break;
            // exponential backoff with jitter
            const backoff = Math.round(500 * Math.pow(2, attempt) + Math.random()*200);
            status.textContent = `Retry ${attempt}/${maxRetries} — waiting ${backoff}ms`;
            await sleep(backoff);
          }
        }
        throw lastErr;
      }

      function clearPreview(){ previewWrap.innerHTML = ''; status.textContent = ''; }

      function showPreviewFromBlob(blob){
        clearPreview();
        const url = URL.createObjectURL(blob);
        const img = document.createElement('img');
        img.className = 'preview';
        img.src = url;
        img.alt = 'secret image';
        img.loading = 'eager';
        previewWrap.appendChild(img);
        const link = document.createElement('a');
        link.href = IMAGE_URL;
        link.target = '_blank'; link.rel = 'noopener noreferrer';
        link.textContent = 'Open image in new tab';
        link.style.display = 'block'; link.style.marginTop = '.5rem';
        previewWrap.appendChild(link);
      }

      async function reveal() {
        text.textContent = 'Loading secret...';
        area.classList.remove('hidden');
        btn.setAttribute('aria-expanded','true');
        status.textContent = 'Fetching image...';
        try {
          const blob = await fetchImageBlob(IMAGE_URL);
          showPreviewFromBlob(blob);
          status.textContent = '';
          text.textContent = "YOU'RE IN MY HOUSE NOW BUD!!!";
        } catch (err) {
          clearPreview();
          status.textContent = 'Failed to load image: ' + (err && err.message ? err.message : err);
          text.innerHTML = 'Image failed to load — <a href="' + IMAGE_URL + '" target="_blank" rel="noopener noreferrer">open image in new tab</a>';
        }
      }

      // input handlers
      input.addEventListener('input', () => {
        if (input.value === SECRET) {
          btn.classList.remove('hidden'); btn.focus();
        } else { btn.classList.add('hidden'); area.classList.add('hidden'); }
      });
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && input.value === SECRET) btn.click(); });

      btn.addEventListener('click', () => {
        // reveal on this page
        reveal();
        // clear session flag
        sessionStorage.removeItem('secret-revealed');
      });

      // Auto reveal when arriving from main page
      if (sessionStorage.getItem('secret-revealed') === '1'){
        sessionStorage.removeItem('secret-revealed');
        // Slight delay to let layout finish
        setTimeout(reveal, 250);
      }

    })();
    </script>
  </body>
</html>
